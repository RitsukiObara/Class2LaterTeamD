//===========================================
//
// 扇風機の処理[electricfan.cpp]
// Author 小原立暉
//
//===========================================
//*******************************************
// インクルードファイル
//*******************************************
#include "main.h"
#include "electricfan.h"
#include "manager.h"
#include "renderer.h"

#include "fan_blade.h"
#include "fan_wind.h"
#include "input.h"

//-------------------------------------------
// マクロ定義
//-------------------------------------------
#define FAN_SHIFT		(175.0f)		// 扇風機の羽根のずらす高さ
#define WIND_CIRCUM		(80.0f)			// 扇風機の風の円周の大きさ
#define WIND_HEIGHT		(1600.0f)		// 扇風機の風の高さ

//==============================
// コンストラクタ
//==============================
CElecFan::CElecFan() : CObstacle(CObject::TYPE_OBSTACLE, CObject::PRIORITY_BLOCK)
{
	// 全ての値をクリアする
	m_pFan = nullptr;			// 扇風機のファン
	m_pWind = nullptr;			// 扇風機の風の情報
	m_bPower = false;			// 電源状況
}

//==============================
// デストラクタ
//==============================
CElecFan::~CElecFan()
{

}

//==============================
// 扇風機の初期化処理
//==============================
HRESULT CElecFan::Init(void)
{
	if (FAILED(CObstacle::Init()))
	{ // 初期化処理に失敗した場合

		// 失敗を返す
		return E_FAIL;
	}

	// 全ての値を初期化する
	m_pFan = nullptr;			// 扇風機のファン
	m_pWind = nullptr;			// 扇風機の風の情報
	m_bPower = false;			// 電源状況

	// 値を返す
	return S_OK;
}

//========================================
// 扇風機の終了処理
//========================================
void CElecFan::Uninit(void)
{
	if (m_pFan != nullptr)
	{ // ファンが NULL じゃない場合

		// ファンの終了処理
		m_pFan->Uninit();
		m_pFan = nullptr;
	}

	if (m_pWind != nullptr)
	{ // 風が NULL じゃない場合

		// 風の終了処理
		m_pWind->Uninit();
		m_pWind = nullptr;
	}

	// 終了処理
	CObstacle::Uninit();
}

//=====================================
// 扇風機の更新処理
//=====================================
void CElecFan::Update(void)
{
	if (m_pFan != nullptr)
	{ // ファンが NULL じゃない場合

		// ファンの更新処理
		m_pFan->Update();
	}

	if (m_pWind != nullptr)
	{ // 風が NULL じゃない場合

		// 風の更新処理
		m_pWind->Update();
	}
}

//=====================================
// 扇風機の描画処理
//=====================================
void CElecFan::Draw(void)
{	
	// デバイスの取得
	LPDIRECT3DDEVICE9 pDevice = CManager::Get()->GetRenderer()->GetDevice();

	// 描画処理
	CObstacle::Draw();

	if (m_pFan != nullptr)
	{ // ファンが NULL じゃない場合

		// ファンの描画処理
		m_pFan->Draw();
	}

	if (m_pWind != nullptr)
	{ // 風が NULL じゃない場合

		// カリングの設定をOFFにする
		pDevice->SetRenderState(D3DRS_CULLMODE, D3DCULL_NONE);

		// 風の描画処理
		m_pWind->Draw();

		// カリングの設定をONにする
		pDevice->SetRenderState(D3DRS_CULLMODE, D3DCULL_CCW);
	}
}

//=====================================
// 情報の設定処理
//=====================================
void CElecFan::SetData(const D3DXVECTOR3& pos, const TYPE type)
{
	// 情報の設定処理
	CObstacle::SetData(pos, type);

	// 全ての値を設定する
	if (m_pFan == nullptr)
	{ // ファンが NULL だった場合

		// 羽根の位置
		D3DXVECTOR3 posFan;

		// 羽根の位置を設定する
		posFan.x = pos.x;
		posFan.y = pos.y + FAN_SHIFT;
		posFan.z = pos.z;

		// ファンを生成する
		m_pFan = CFanBlade::Create(posFan);
	}

	if (m_pWind == nullptr)
	{ // 風の情報が NULL の場合

		// 風を生成する
		m_pWind = CFanWind::Create(m_pFan->GetPos(), D3DXVECTOR3(-D3DX_PI * 0.5f, GetRot().y, GetRot().z), WIND_CIRCUM, WIND_HEIGHT);
	}
}

//=====================================
// 当たり判定処理
//=====================================
bool CElecFan::Collision(D3DXVECTOR3& pos, const D3DXVECTOR3& posOld, const float fWidth, const float fHeight, const float fDepth, const CPlayer::TYPE type)
{
	// false を返す
	return false;
}

//=====================================
// ヒット処理
//=====================================
bool CElecFan::Hit(const D3DXVECTOR3& pos, const float fWidth, const float fHeight, const float fDepth, const CPlayer::TYPE type)
{
	// false を返す
	return false;
}

//=====================================
// ヒット処理
//=====================================
bool CElecFan::HitCircle(const D3DXVECTOR3& pos, const float Radius, const CPlayer::TYPE type)
{
	// false を返す
	return true;
}

//=====================================
// ギミック起動処理
//=====================================
void CElecFan::Action(void)
{
	// 電源ONにする
	m_bPower = true;

	if (m_pWind == nullptr)
	{ // 風の情報が NULL の場合

		// 風を生成する
		m_pWind = CFanWind::Create(m_pFan->GetPos(), D3DXVECTOR3(D3DX_PI * 0.5f, GetRot().y, GetRot().z), 40.0f, 80.0f);
	}
}